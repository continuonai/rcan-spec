---
import QRCode from 'qrcode';

interface Props {
  url: string;
  size?: number;
  title?: string;
  showDownload?: boolean;
}

const { url, size = 150, title, showDownload = true } = Astro.props;

const svgString = await QRCode.toString(url, {
  type: 'svg',
  width: size,
  margin: 1,
  color: {
    dark: '#e8e6e3',
    light: '#0a0a0f',
  },
});
---

<div class="qr-container">
  <div class="qr-code" set:html={svgString} />
  {title && <p class="qr-title">{title}</p>}
  {showDownload && (
    <div class="qr-actions">
      <button class="download-btn" data-svg={svgString} data-filename={title?.replace(/\s+/g, '-') || 'qrcode'}>
        Download SVG
      </button>
      <button class="copy-btn" data-url={url}>
        Copy URL
      </button>
    </div>
  )}
</div>

<script>
  document.querySelectorAll('.download-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const svg = (btn as HTMLElement).dataset.svg;
      const filename = (btn as HTMLElement).dataset.filename;
      if (!svg) return;

      const blob = new Blob([svg], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${filename}.svg`;
      a.click();
      URL.revokeObjectURL(url);
    });
  });

  document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const url = (btn as HTMLElement).dataset.url;
      if (!url) return;

      try {
        await navigator.clipboard.writeText(url);
        const originalText = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });
  });
</script>

<style>
  .qr-container {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem;
    background: var(--color-bg-alt);
    border: 1px solid var(--color-border);
    border-radius: 12px;
  }

  .qr-code {
    background: var(--color-bg);
    padding: 0.5rem;
    border-radius: 8px;
  }

  .qr-code :global(svg) {
    display: block;
  }

  .qr-title {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    text-align: center;
    margin: 0;
    max-width: 180px;
    word-break: break-all;
  }

  .qr-actions {
    display: flex;
    gap: 0.5rem;
  }

  .download-btn,
  .copy-btn {
    font-size: 0.7rem;
    padding: 0.35rem 0.6rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-text-muted);
    cursor: pointer;
    transition: all 0.2s;
  }

  .download-btn:hover,
  .copy-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }
</style>
